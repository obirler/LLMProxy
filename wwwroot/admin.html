<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Proxy Admin</title>

    <!-- Link to Local Bootstrap CSS -->
    <link href="/lib/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Optional: Add a custom CSS file for minor tweaks if Bootstrap isn't enough -->
    <!-- <link href="/css/admin-custom.css" rel="stylesheet"> -->

    <style>
        /* Minimal custom styles, if any needed at all */
        .model-config {
            /* Bootstrap card class can replace most of this */
        }

        .backend {
            /* Bootstrap card can replace most of this */
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <header class="pb-3 mb-4 border-bottom">
            <h1 class="h3">LLM Proxy Configuration</h1>
        </header>

        <div id="status-message" role="alert" class="mb-3"></div> <!-- Will be populated by JS -->

        <div id="config-container" class="mb-4">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading configuration...</span>
                </div>
                <p class="mt-2">Loading configuration...</p>
            </div>
        </div>

        <div id="add-model-section" class="mt-5 pt-4 border-top">
            <h2 class="h4">Add New Model</h2>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label for="new-model-name" class="form-label">Model Name (e.g., gpt-4o):</label>
                    <input type="text" id="new-model-name" class="form-control" placeholder="Enter unique model name">
                </div>
                <div class="col-md-6">
                    <button class="btn btn-primary w-100" onclick="addEmptyModel()">Add Model Section</button>
                </div>
            </div>
        </div>
    </div> <!-- End .container -->

    <script>
        const configContainer = document.getElementById('config-container');
        const newModelNameInput = document.getElementById('new-model-name');
        const statusMessage = document.getElementById('status-message');
        const apiUrl = '/admin/config';

        // --- Data Loading and Rendering ---

        async function loadConfig() {
            configContainer.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading configuration...</span>
                        </div>
                        <p class="mt-2">Loading configuration...</p>
                    </div>`;
            statusMessage.textContent = '';
            statusMessage.className = 'mb-3'; // Reset classes
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const config = await response.json();
                renderConfig(config.models || {});
            } catch (error) {
                console.error('Error loading config:', error);
                configContainer.innerHTML = '<div class="alert alert-danger">Error loading configuration. Check console.</div>';
                showStatus(`Error loading config: ${error.message}`, true);
            }
        }

        function renderConfig(models) {
            configContainer.innerHTML = '';
            if (Object.keys(models).length === 0) {
                configContainer.innerHTML = '<div class="alert alert-info">No models configured yet. Use the form below to add one.</div>';
            } else {
                for (const modelName in models) {
                    configContainer.appendChild(createModelElement(modelName, models[modelName]));
                }
            }
        }

        function createModelElement(modelName, modelConfig) {
            const modelCard = document.createElement('div');
            modelCard.className = 'card model-config mb-4 shadow-sm'; // Bootstrap card
            modelCard.id = `model-${modelName}`;

            modelCard.innerHTML = `
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${modelName}</h5>
                            <div>
                                <button class="btn btn-success btn-sm me-2" onclick="saveModelConfig('${modelName}')">Save Changes</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteModelConfig('${modelName}')">Delete Model</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="strategy-${modelName}" class="form-label">Routing Strategy:</label>
                                <select id="strategy-${modelName}" class="form-select">
                                    <option value="RoundRobin" ${modelConfig.strategy === 'RoundRobin' ? 'selected' : ''}>Round Robin</option>
                                    <option value="Failover" ${modelConfig.strategy === 'Failover' ? 'selected' : ''}>Failover</option>
                                    <option value="Weighted" ${modelConfig.strategy === 'Weighted' ? 'selected' : ''}>Weighted</option>
                                </select>
                            </div>
                        </div>
                        <h6>Backends:</h6>
                        <div id="backends-${modelName}" class="mb-3">
                            ${modelConfig.backends.map((backend, index) => createBackendElement(modelName, backend, index)).join('') || '<p class="text-muted">No backends added yet.</p>'}
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="addBackend('${modelName}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill me-1" viewBox="0 0 16 16">
                              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z" />
                            </svg>
                            Add Backend
                        </button>
                    </div>
                `;
            return modelCard;
        }

        function createBackendElement(modelName, backend, index) {
            const backendId = `backend-${modelName}-${index}`; // Temporary ID for new elements
            // Use a unique ID based on backend name if it exists for existing elements
            const elementId = backend.name ? `backend-${modelName}-${backend.name.replace(/[^a-zA-Z0-9-_]/g, '')}` : backendId;

            return `
                    <div class="card backend mb-3" id="${elementId}">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="name-${elementId}" class="form-label">Backend Name:</label>
                                    <input type="text" id="name-${elementId}" class="form-control form-control-sm backend-name" value="${backend.name || ''}" placeholder="Unique name (e.g., OpenAI-EU)">
                                </div>
                                <div class="col-md-6">
                                    <label for="baseUrl-${elementId}" class="form-label">Base URL:</label>
                                    <input type="text" id="baseUrl-${elementId}" class="form-control form-control-sm backend-baseUrl" value="${backend.baseUrl || ''}" placeholder="e.g., https://api.openai.com/v1">
                                </div>
                                <div class="col-12">
                                    <label for="apiKeys-${elementId}" class="form-label">API Keys (comma-separated):</label>
                                    <textarea id="apiKeys-${elementId}" class="form-control form-control-sm backend-apiKeys" rows="2" placeholder="key1,key2,key3">${backend.apiKeys ? backend.apiKeys.join(',') : ''}</textarea>
                                </div>
                                <div class="col-md-8">
                                    <label for="backendModelName-${elementId}" class="form-label">Backend-Specific Model Name (Optional):</label>
                                    <input type="text" id="backendModelName-${elementId}" class="form-control form-control-sm backend-backendModelName" value="${backend.backendModelName || ''}" placeholder="Overrides main model name">
                                </div>
                                 <div class="col-md-4">
                                    <label for="weight-${elementId}" class="form-label">Weight:</label>
                                    <input type="number" id="weight-${elementId}" class="form-control form-control-sm backend-weight" value="${backend.weight || 1}" min="1">
                                </div>
                                <div class="col-12 d-flex justify-content-between align-items-center mt-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input backend-enabled" type="checkbox" role="switch" id="enabled-${elementId}" ${backend.enabled !== false ? 'checked' : ''}>
                                        <label class="form-check-label" for="enabled-${elementId}">Enabled</label>
                                    </div>
                                    <button class="btn btn-outline-danger btn-sm" onclick="removeBackendElement('${elementId}')">Remove Backend</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        // --- UI Actions ---

        function addEmptyModel() {
            const modelName = newModelNameInput.value.trim();
            if (!modelName) {
                showStatus("Please enter a model name.", true);
                return;
            }
            if (document.getElementById(`model-${modelName}`)) {
                showStatus(`Model "${modelName}" already exists. Edit the section above.`, true);
                return;
            }

            const newModelConfig = { strategy: 'Failover', backends: [] };
            configContainer.appendChild(createModelElement(modelName, newModelConfig));
            newModelNameInput.value = '';
            showStatus(`Added section for model "${modelName}". Add backends and click Save.`, false);
        }

        function addBackend(modelName) {
            const backendsDiv = document.getElementById(`backends-${modelName}`);
            // Check if the "No backends added yet" placeholder is there
            const placeholder = backendsDiv.querySelector('p.text-muted');
            if (placeholder) {
                placeholder.remove();
            }

            const newIndex = backendsDiv.querySelectorAll('.backend').length;
            const newBackend = { name: '', baseUrl: '', apiKeys: [], backendModelName: null, weight: 1, enabled: true };
            const backendHtml = createBackendElement(modelName, newBackend, newIndex);
            backendsDiv.insertAdjacentHTML('beforeend', backendHtml);
        }

        function removeBackendElement(backendElementId) {
            const backendElement = document.getElementById(backendElementId);
            if (backendElement) {
                const parentBackendsDiv = backendElement.parentElement;
                backendElement.remove();
                if (parentBackendsDiv && parentBackendsDiv.querySelectorAll('.backend').length === 0) {
                    parentBackendsDiv.innerHTML = '<p class="text-muted">No backends added yet.</p>';
                }
            }
        }

        // --- API Interaction ---

        async function saveModelConfig(modelName) {
            statusMessage.textContent = 'Saving...';
            statusMessage.className = 'alert alert-info mb-3'; // Indicate saving

            const modelDiv = document.getElementById(`model-${modelName}`);
            if (!modelDiv) {
                showStatus(`Error: Could not find model element for ${modelName}.`, true);
                return;
            }
            const strategy = modelDiv.querySelector(`#strategy-${modelName}`).value;
            const backendElements = modelDiv.querySelectorAll(`#backends-${modelName} .backend`);

            const backends = [];
            let hasError = false;
            backendElements.forEach((be) => {
                const name = be.querySelector('.backend-name').value.trim();
                const baseUrl = be.querySelector('.backend-baseUrl').value.trim();
                const apiKeysRaw = be.querySelector('.backend-apiKeys').value.trim();
                const backendModelName = be.querySelector('.backend-backendModelName').value.trim() || null;
                const weight = parseInt(be.querySelector('.backend-weight').value, 10);
                const enabled = be.querySelector('.backend-enabled').checked;

                if (!name) {
                    showStatus(`Error: Backend name is required for all backends in model ${modelName}.`, true);
                    hasError = true; return;
                }
                if (!baseUrl) {
                    showStatus(`Error: Base URL is required for backend "${name}" in model ${modelName}.`, true);
                    hasError = true; return;
                }
                const apiKeys = apiKeysRaw ? apiKeysRaw.split(',').map(k => k.trim()).filter(k => k) : [];

                backends.push({ name, baseUrl, apiKeys, backendModelName, weight: isNaN(weight) || weight < 1 ? 1 : weight, enabled });
            });

            if (hasError) return;

            const payload = { strategy, backends };

            try {
                const response = await fetch(`${apiUrl}/${encodeURIComponent(modelName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                showStatus(`Successfully saved configuration for model ${modelName}.`, false);
            } catch (error) {
                console.error(`Error saving config for ${modelName}:`, error);
                showStatus(`Error saving config for ${modelName}: ${error.message || 'Unknown error'}`, true);
            }
        }

        async function deleteModelConfig(modelName) {
            if (!confirm(`Are you sure you want to delete the entire configuration for model "${modelName}"?`)) {
                return;
            }
            statusMessage.textContent = 'Deleting...';
            statusMessage.className = 'alert alert-info mb-3';
            try {
                const response = await fetch(`${apiUrl}/${encodeURIComponent(modelName)}`, { method: 'DELETE' });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                showStatus(`Successfully deleted configuration for model ${modelName}.`, false);
                document.getElementById(`model-${modelName}`)?.remove();
                if (configContainer.children.length === 0) {
                    configContainer.innerHTML = '<div class="alert alert-info">No models configured yet. Use the form below to add one.</div>';
                }
            } catch (error) {
                console.error(`Error deleting config for ${modelName}:`, error);
                showStatus(`Error deleting config for ${modelName}: ${error.message || 'Unknown error'}`, true);
            }
        }

        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `alert ${isError ? 'alert-danger' : 'alert-success'} mb-3`;
            // Auto-clear can be added if desired
            // setTimeout(() => { /* ... */ }, 5000);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', loadConfig);
    </script>

    <!-- Link to Local Bootstrap JS Bundle (Popper included) -->
    <script src="/lib/bootstrap/js/bootstrap.js"></script>
</body>
</html>